# Copyright 2025 Canonical Ltd.
# See LICENSE file for licensing details.
type: charm
base: ubuntu@24.04
build-base: ubuntu@24.04

platforms:
  amd64:

parts:
  charm:
    source: .
    plugin: uv
    build-snaps:
    - astral-uv

name: haproxy-ddos-protection-configurator
title: HAProxy DDoS protection configurator
description: |
  A [Juju](https://juju.is/) [charm](https://juju.is/docs/olm/charmed-operators)
  that serves as a configurator for HAProxy to provide DDoS protection capabilities.

  HAProxy is a TCP/HTTP reverse proxy which is particularly suited for high
  availability environments. Since the HAProxy charm currently has many configuration options,
  this configurator charm aims to simplify the deployment of HAProxy with DDoS by separating the
  DDoS configuration from the main HAProxy charm.

summary: DDoS protection configurator for HAProxy charm.
links:
  documentation: 
    https://documentation.ubuntu.com/haproxy-charm/latest/
  issues: https://github.com/canonical/haproxy-operator/issues
  source: https://github.com/canonical/haproxy-operator/haproxy-ddos-protection-configurator
  contact:
  - https://launchpad.net/~canonical-is-devops

assumes:
- juju >= 3.6

config:
  options:
    rate-limit-requests-per-minute:
      type: int
      description: Maximum number of requests per minute per entry to trigger the limit policy.
    rate-limit-connections-per-minute:
      type: int
      description: Maximum number of connections per minute per entry to trigger the limit policy.
    concurrent-connections-limit:
      type: int
      description: Maximum number of concurrent connections per entry to trigger the limit policy.
    error-rate-per-minute:
      type: int
      description: Number of errors per minute per entry to trigger the limit policy.
    limit-policy-http:
      type: string
      description: |
        Policy to be applied when HTTP-level limits are exceeded (rate-limit-requests-per-minute, 
        error-rate-per-minute). Specify one of- silent-drop, reject, or deny. Optionally append 
        an HTTP status code for deny (default is 403). Examples- 'reject', 'deny', 'deny 503'.
        Default is 'silent-drop'.
    limit-policy-tcp:
      type: string
      description: |
        Policy to be applied when TCP-level limits are exceeded (rate-limit-connections-per-minute, 
        concurrent-connections-limit). Specify one of- 'silent-drop' or 'reject'. Default is 
        'silent-drop'.
    ip-allow-list:
      type: string
      description: |
        Comma-separated list of IPv4 addresses or CIDR blocks to be allowed on both TCP and 
        HTTP levels.
    http-request-timeout:
      type: int
      description: Timeout for HTTP requests in seconds.
    http-keepalive-timeout:
      type: int
      description: Timeout for HTTP keep-alive connections in seconds.
    client-timeout:
      type: int
      description: Timeout for client connections in seconds. Default is 50 seconds.
    deny-paths:
      type: string
      description: Comma-seperated list of paths to deny.

charm-libs:
- lib: haproxy.ddos_protection
  version: "0"

provides:
  ddos-protection:
    interface: ddos_protection
    limit: 1

