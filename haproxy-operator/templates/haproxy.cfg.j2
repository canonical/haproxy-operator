{%- macro ddos_protection_rules() -%}
{% if ddos_protection_config.has_rate_limiting %}
    tcp-request connection track-sc0 src table haproxy_peers/ddos_protection_ip
{% if ddos_protection_config.rate_limit_connections_per_minute %}
    tcp-request connection {{ ddos_protection_config.limit_policy_tcp }} if { sc_conn_rate(0) gt {{ ddos_protection_config.rate_limit_connections_per_minute }} }
{% endif %}
{% if ddos_protection_config.concurrent_connections_limit %}
    tcp-request connection {{ ddos_protection_config.limit_policy_tcp }} if { sc_conn_cur(0) gt {{ ddos_protection_config.concurrent_connections_limit }} }
{% endif %}
{% if ddos_protection_config.error_rate %}
    http-request {{ ddos_protection_config.limit_policy_http }}{{ ' deny_status ' ~ ddos_protection_config.policy_status_code if ddos_protection_config.limit_policy_http == 'deny' and ddos_protection_config.policy_status_code else '' }} if { sc_http_err_rate(0) gt {{ ddos_protection_config.error_rate }} }
{% endif %}
{% if ddos_protection_config.rate_limit_requests_per_minute %}
    http-request {{ ddos_protection_config.limit_policy_http }}{{ ' deny_status ' ~ ddos_protection_config.policy_status_code if ddos_protection_config.limit_policy_http == 'deny' and ddos_protection_config.policy_status_code else '' }} if { sc_http_req_rate(0) gt {{ ddos_protection_config.rate_limit_requests_per_minute }} }
{% endif %}
{% endif %}
{% if ddos_protection %}
    acl invalid_method method TRACE TRACK DEBUG
    acl empty_method method -i ""
    acl has_host hdr(Host) -m found
    http-request silent-drop if invalid_method empty_method !has_host
{% endif %}
{% if ddos_protection_config.ip_allow_list_file_path %}
    acl allowed_ips src -f {{ ddos_protection_config.ip_allow_list_file_path }}
    http-request allow if allowed_ips
{% endif %}
{% if ddos_protection_config.deny_paths_file_path %}
    acl denied_paths path_beg -f {{ ddos_protection_config.deny_paths_file_path }}
    http-request deny if denied_paths
{% endif %}
{% if ddos_protection_config.http_request_timeout %}
    timeout http-request {{ ddos_protection_config.http_request_timeout }}
{% endif %}
{% if ddos_protection_config.http_keepalive_timeout %}
    timeout http-keep-alive {{ ddos_protection_config.http_keepalive_timeout }}
{% endif %}
{% if ddos_protection_config.client_timeout %}
    timeout client {{ ddos_protection_config.client_timeout }}
{% endif %}
{%- endmacro -%}


global
    maxconn {{ config_global_max_connection }}
    user haproxy
    group haproxy

    log /dev/log local0

    # haproxy 2.8, intermediate config, OpenSSL 1.1.1k
    # https://ssl-config.mozilla.org/#server=haproxy&version=2.8&config=intermediate&openssl=1.1.1k&guideline=5.7

    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-CHACHA20-POLY1305
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-bind-options prefer-client-ciphers no-sslv3 no-tlsv10 no-tlsv11 no-tls-tickets

    ssl-default-server-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-CHACHA20-POLY1305
    ssl-default-server-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-server-options no-sslv3 no-tlsv10 no-tlsv11 no-tls-tickets

    ssl-dh-param-file /etc/haproxy/ffdhe2048.txt

defaults
    log global
    mode http
    option httplog
    option dontlognull
    retries 3
    timeout queue 20000
{% if ddos_protection %}
    timeout http-request 60000
    timeout http-keep-alive 30000
    timeout client 50000
{% endif %}
    timeout connect 5000
    timeout server 50000

frontend prometheus
    bind :9123
    mode http
    http-request use-service prometheus-exporter if { path /metrics }
    no log

{% block proxy_configuration %}
frontend default
    bind :80
    default_backend default
{% endblock %}

backend default
    http-request return status 200 content-type "text/plain" string "Default page for the haproxy-operator charm"
